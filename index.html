<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tasbih Counter</title>

<style>
  body {
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  /* Reset Button (Top Right) */
  #reset {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #4caf50;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #reset:active { background: #388e3c; }

  /* Big Circle Increment Button */
  #bigCircle {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    border: 6px solid #4caf50;
    margin: 40px auto 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    position: relative;
  }

  /* Progress Ring */
  svg {
    position: absolute;
    top: 0;
    left: 0;
    transform: rotate(-90deg);
    pointer-events: none;
  }

  /* Settings */
  .settings {
    margin-top: 20px;
    font-size: 1.1rem;
  }
  label { margin: 0 10px; }
  input[type="number"] { width: 70px; padding: 5px; }

  /* Timer */
  #timer {
    font-size: 1.2rem;
    margin-top: 10px;
    color: #333;
  }

  /* Custom Modal */
  .modal {
    display: none;
    position: fixed;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .modal.show { display: flex; }

  .modal-content {
    background: white;
    padding: 20px;
    width: 280px;
    border-radius: 12px;
    text-align: center;
    animation: fadeIn .2s ease-in-out;
  }

  .modal-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
  }

  .yes-btn {
    background: #e63946;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .no-btn {
    background: #ccc;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(.9); }
    to { opacity: 1; transform: scale(1); }
  }
</style>
</head>

<body>

<!-- Reset Button -->
<button id="reset">Reset</button>

<!-- Increment Circle -->
<div id="bigCircle">
  <span id="count">0</span>
  <svg width="200" height="200">
    <circle cx="100" cy="100" r="90" stroke="#ccc" stroke-width="10" fill="none"/>
    <circle id="progress" cx="100" cy="100" r="90" stroke="#4caf50" stroke-width="10"
            fill="none" stroke-dasharray="565" stroke-dashoffset="565"/>
  </svg>
</div>

<!-- Timer -->
<div id="timer">Time: 00:00:00</div>

<!-- Settings -->
<div class="settings">
  <label>Target: <input type="number" id="target" value="100"></label>
  <label><input type="checkbox" id="vibrate"> Vibration</label>
  <label><input type="checkbox" id="sound"> Sound</label>
</div>

<!-- Custom Reset Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>Reset Counter?</h3>
    <p>Your current count & timer will be reset.</p>
    <div class="modal-buttons">
      <button id="confirmYes" class="yes-btn">Yes</button>
      <button id="confirmNo" class="no-btn">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ------------------------
     LocalStorage Helpers
------------------------ */
const get = (k, d) => JSON.parse(localStorage.getItem(`rosary-${k}`)) ?? d;
const set = (k, v) => localStorage.setItem(`rosary-${k}`, JSON.stringify(v));

/* ------------------------
     DOM Elements
------------------------ */
const countEl = document.querySelector("#count");
const progressEl = document.querySelector("#progress");
const bigCircle = document.querySelector("#bigCircle");
const resetBtn = document.querySelector("#reset");
const targetInput = document.querySelector("#target");
const vibrateToggle = document.querySelector("#vibrate");
const soundToggle = document.querySelector("#sound");
const timerEl = document.querySelector("#timer");

/* ------------------------
      Load Stored Values
------------------------ */
let count = get("count", 0);
let target = get("target", 100);
let vibrate = get("vibrate", false);
let sound = get("sound", false);
let startTime = get("startTime", Date.now());

/* Apply UI state */
targetInput.value = target;
vibrateToggle.checked = vibrate;
soundToggle.checked = sound;

/* ------------------------
      TIMER HANDLER
------------------------ */
function updateTimer() {
  let diff = Math.floor((Date.now() - startTime) / 1000);
  let h = String(Math.floor(diff / 3600)).padStart(2, "0");
  let m = String(Math.floor((diff % 3600) / 60)).padStart(2, "0");
  let s = String(diff % 60).padStart(2, "0");
  timerEl.textContent = `Time: ${h}:${m}:${s}`;
}
setInterval(updateTimer, 1000);
updateTimer();

/* ------------------------
        UPDATE DISPLAY
------------------------ */
function updateDisplay() {
  countEl.textContent = count;

  const percent = Math.min(count / target, 1);
  const offset = 565 - (565 * percent);
  progressEl.style.strokeDashoffset = offset;

  set("count", count);
  set("target", target);
  set("vibrate", vibrate);
  set("sound", sound);

  // Target-reached sound alert
  if (sound && count >= target) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    osc.type = "square";
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.15);
  }
}

/* ------------------------
        BEEP
------------------------ */
function beep() {
  if (!sound) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.type = "sine";
  osc.frequency.setValueAtTime(600, ctx.currentTime);
  osc.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 0.1);
}

/* ------------------------
       VIBRATION
------------------------ */
function vibrateFun() {
  if (vibrate && navigator.vibrate) navigator.vibrate(50);
}

/* ------------------------
        INCREMENT
------------------------ */
function increment() {
  count++;
  updateDisplay();
  beep();
  vibrateFun();
}

/* Big circle click */
bigCircle.addEventListener("click", increment);

/* Space/Enter key */
document.addEventListener("keydown", e => {
  if (e.code === "Space" || e.code === "Enter") {
    e.preventDefault();
    increment();
  }
});

/* ------------------------
        AUTO HOLD
------------------------ */
let autoInterval;
bigCircle.addEventListener("mousedown", e => {
  autoInterval = setInterval(increment, 200);
});
document.addEventListener("mouseup", e => clearInterval(autoInterval));

/* ------------------------
     SETTINGS CHANGES
------------------------ */
targetInput.addEventListener("change", e => {
  target = parseInt(targetInput.value) || 100;
  set("target", target);
  updateDisplay();
});
vibrateToggle.addEventListener("change", e => {
  vibrate = vibrateToggle.checked;
  set("vibrate", vibrate);
});
soundToggle.addEventListener("change", e => {
  sound = soundToggle.checked;
  set("sound", sound);
});

/* ------------------------
     RESET WITH MODAL
------------------------ */
const modal = document.querySelector("#confirmModal");
const yesBtn = document.querySelector("#confirmYes");
const noBtn = document.querySelector("#confirmNo");

resetBtn.addEventListener("click", e => modal.classList.add("show"));

noBtn.addEventListener("click", e => modal.classList.remove("show"));

yesBtn.addEventListener("click", e => {
  count = 0;
  startTime = Date.now();
  set("startTime", startTime);
  updateDisplay();
  updateTimer();
  modal.classList.remove("show");
});

(e => updateDisplay())();
</script>

</body>
</html>
