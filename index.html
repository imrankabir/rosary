<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<link rel="shortcut icon" type="image/x-icon" href="favicon.png">
<title>Rosary</title>

<style>
  body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    text-align: center;
    align-items: center;
    background: #f5f5f5;
    flex-direction: column;
    justify-content: center;
    font-family: Arial, sans-serif;
  }

  /* Reset Button (Top Right) */
  #reset {
    top: 15px;
    right: 15px;
    color: white;
    border: none;
    cursor: pointer;
    padding: 8px 14px;
    border-radius: 8px;
    position: absolute;
    background: #4caf50;
  }
  #reset:active { background: #388e3c; }

  /* Big Circle Increment Button */
  #bigCircle {
    width: 200px;
    height: 200px;
    display: flex;
    font-size: 3rem;
    cursor: pointer;
    font-weight: bold;
    user-select: none;
    border-radius: 50%;
    position: relative;
    align-items: center;
    margin: 40px auto 10px;
    justify-content: center;
    border: 6px solid #4caf50;
  }

  /* Progress Ring */
  svg {
    top: 0;
    left: 0;
    position: absolute;
    pointer-events: none;
    transform: rotate(-90deg);
  }

  /* Settings */
  .settings {
    margin-top: 20px;
    font-size: 1.1rem;
  }
  label { margin: 0 10px; }
  input[type="number"] { width: 70px; padding: 5px; }

  /* Timer */
  #timer {
    color: #333;
    margin-top: 10px;
    font-size: 1.2rem;
  }

  /* Custom Modal */
  .modal {
    display: none;
    z-index: 9999;
    position: fixed;
    left: 0; top: 0;
    align-items: center;
    justify-content: center;
    width: 100%; height: 100%;
    backdrop-filter: blur(4px);
    background: rgba(0,0,0,0.4);
  }
  .modal.show { display: flex; }

  .modal-content {
    width: 280px;
    padding: 20px;
    background: white;
    text-align: center;
    border-radius: 12px;
    animation: fadeIn .2s ease-in-out;
  }

  .modal-buttons {
    display: flex;
    margin-top: 20px;
    justify-content: space-between;
  }

  .yes-btn {
    color: white;
    border: none;
    cursor: pointer;
    padding: 10px 15px;
    border-radius: 8px;
    background: #e63946;
  }
  .no-btn {
    border: none;
    cursor: pointer;
    background: #ccc;
    padding: 10px 15px;
    border-radius: 8px;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(.9); }
    to { opacity: 1; transform: scale(1); }
  }
</style>
</head>

<body>

<!-- Reset Button -->
<button id="reset">Reset</button>

<!-- Increment Circle -->
<div id="bigCircle">
  <span id="count">0</span>
  <svg width="200" height="200">
    <circle cx="100" cy="100" r="90" stroke="#ccc" stroke-width="10" fill="none"/>
    <circle id="progress" cx="100" cy="100" r="90" stroke="#4caf50" stroke-width="10"
            fill="none" stroke-dasharray="565" stroke-dashoffset="565"/>
  </svg>
</div>

<!-- Timer -->
<div id="timer">Time: 00:00:00</div>

<!-- Settings -->
<div class="settings">
  <label>Target: <input type="number" id="target" value="100"></label>
  <label><input type="checkbox" id="vibrate"> Vibration</label>
  <label><input type="checkbox" id="sound"> Sound</label>
</div>

<!-- Custom Reset Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>Reset Counter?</h3>
    <p>Your current count & timer will be reset.</p>
    <div class="modal-buttons">
      <button id="confirmYes" class="yes-btn">Yes</button>
      <button id="confirmNo" class="no-btn">Cancel</button>
    </div>
  </div>
</div>
<script>
/* ------------------------
     LocalStorage Helpers
------------------------ */
const get = (k, d) => JSON.parse(localStorage.getItem(`rosary-${k}`)) ?? d;
const set = (k, v) => localStorage.setItem(`rosary-${k}`, JSON.stringify(v));

/* ------------------------
     DOM Elements
------------------------ */
const countEl = document.querySelector("#count");
const progressEl = document.querySelector("#progress");
const bigCircle = document.querySelector("#bigCircle");
const resetBtn = document.querySelector("#reset");
const targetInput = document.querySelector("#target");
const vibrateToggle = document.querySelector("#vibrate");
const soundToggle = document.querySelector("#sound");
const timerEl = document.querySelector("#timer");

/* ------------------------
      Load Stored Values
------------------------ */
let count = get("count", 0);
let target = get("target", 100);
let vibrate = get("vibrate", false);
let sound = get("sound", false);

/* TIMER STATE (FIXED) */
let elapsedSeconds = get("elapsedSeconds", 0);
let lastActiveTime = null;
let timerInterval = null;

/* Apply UI state */
targetInput.value = target;
vibrateToggle.checked = vibrate;
soundToggle.checked = sound;

/* ------------------------
      TIMER FUNCTIONS
------------------------ */
function formatTime(totalSeconds) {
  const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
  const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
  const s = String(totalSeconds % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

function updateTimerUI() {
  timerEl.textContent = `Time: ${formatTime(elapsedSeconds)}`;
}

function startTimer() {
  if (timerInterval) return;

  lastActiveTime = Date.now();
  timerInterval = setInterval(() => {
    const now = Date.now();
    const diff = Math.floor((now - lastActiveTime) / 1000);
    if (diff > 0) {
      elapsedSeconds += diff;
      lastActiveTime = now;
      set("elapsedSeconds", elapsedSeconds);
      updateTimerUI();
    }
  }, 1000);
}

function stopTimer() {
  if (!timerInterval) return;

  const now = Date.now();
  elapsedSeconds += Math.floor((now - lastActiveTime) / 1000);
  set("elapsedSeconds", elapsedSeconds);

  clearInterval(timerInterval);
  timerInterval = null;
}

/* ------------------------
   PAGE VISIBILITY HANDLER
------------------------ */
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    if (count > 0) startTimer();
  } else {
    stopTimer();
  }
});

/* ------------------------
        UPDATE DISPLAY
------------------------ */
function updateDisplay() {
  countEl.textContent = count;

  const percent = Math.min(count / target, 1);
  const offset = 565 - (565 * percent);
  progressEl.style.strokeDashoffset = offset;

  set("count", count);
  set("target", target);
  set("vibrate", vibrate);
  set("sound", sound);

  if (sound && count >= target) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    osc.type = "square";
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.15);
  }
}

/* ------------------------
        BEEP
------------------------ */
function beep() {
  if (!sound) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.type = "sine";
  osc.frequency.setValueAtTime(600, ctx.currentTime);
  osc.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 0.1);
}

/* ------------------------
       VIBRATION
------------------------ */
function vibrateFun() {
  if (vibrate && navigator.vibrate) navigator.vibrate(50);
}

/* ------------------------
        INCREMENT
------------------------ */
function increment() {
  if (count === 0 && !timerInterval) {
    startTimer();
  }

  count++;
  updateDisplay();
  beep();
  vibrateFun();
}

/* ------------------------
        EVENTS
------------------------ */
bigCircle.addEventListener("click", increment);

document.addEventListener("keydown", e => {
  if (e.code === "Space" || e.code === "Enter") {
    e.preventDefault();
    increment();
  }
});

/* AUTO HOLD */
let autoInterval;
bigCircle.addEventListener("mousedown", () => {
  autoInterval = setInterval(increment, 200);
});
document.addEventListener("mouseup", () => clearInterval(autoInterval));

/* ------------------------
     SETTINGS CHANGES
------------------------ */
targetInput.addEventListener("change", () => {
  target = parseInt(targetInput.value) || 100;
  updateDisplay();
});

vibrateToggle.addEventListener("change", () => {
  vibrate = vibrateToggle.checked;
  set("vibrate", vibrate);
});

soundToggle.addEventListener("change", () => {
  sound = soundToggle.checked;
  set("sound", sound);
});

/* ------------------------
     RESET WITH MODAL
------------------------ */
const modal = document.querySelector("#confirmModal");
const yesBtn = document.querySelector("#confirmYes");
const noBtn = document.querySelector("#confirmNo");

resetBtn.addEventListener("click", () => modal.classList.add("show"));
noBtn.addEventListener("click", () => modal.classList.remove("show"));

yesBtn.addEventListener("click", () => {
  count = 0;
  elapsedSeconds = 0;
  set("elapsedSeconds", 0);

  updateTimerUI();
  updateDisplay();

  modal.classList.remove("show");
});

/* ------------------------
      INITIAL LOAD
------------------------ */
updateDisplay();
updateTimerUI();

if (document.visibilityState === "visible" && count > 0) {
  startTimer();
}
</script>

</body>
</html>
